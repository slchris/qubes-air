# Qubes Air - Lint Workflow
#
# 代码质量检查和格式化验证

name: Lint

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  GO_VERSION: '1.22'
  NODE_VERSION: '20'

jobs:
  # Go Lint
  golangci-lint:
    name: Go Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: console/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: console/backend/go.sum

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: v1.55
          working-directory: console/backend
          args: --timeout=5m

  # Go 单元测试
  go-test:
    name: Go Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: console/backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: console/backend/go.sum

      - name: Run tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: go-coverage
          path: console/backend/coverage.out
          retention-days: 7

  # Frontend Lint (ESLint + Svelte Check)
  frontend-lint:
    name: Frontend Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: console/frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: console/frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Svelte Check
        run: npm run check

  # Shell Script Lint
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: './dom0-scripts'
          additional_files: 'crypto/scripts/*.sh packer/scripts/*.sh'

  # YAML Lint
  yaml-lint:
    name: YAML Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@v3
        with:
          file_or_dir: |
            ansible/
            salt/
            .github/workflows/
          config_file: .yamllint.yml
